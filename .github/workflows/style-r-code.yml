# This action runs styler::style_pkg() to style r code in an r pkg's repo. After
# styling, the changes are commited and a pull request to the branch the Workflow
# was started on is opened - this PR contains the commit.

# Workflow derived from https://github.com/r-lib/actions/tree/master/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
 workflow_call:

name: style r code with styler

jobs:
  style:
    name: style
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v2

      - uses: r-lib/actions/setup-r@v1

      - name: Install dependencies
        run: Rscript -e 'install.packages("styler")'

      - name: get last commit msg
        id: commit-msg
        run: |
          git tag
          last_commit_msg=$(git log -1 --pretty=%B)
          echo "::set-output name=msg::${last_commit_msg}"

      - name: Style
        run: Rscript -e 'styler::style_pkg()'
        
      - name: Create Pull Request
        if: ${{ !contains(steps.commit-msg.outputs.msg, 'style_pkg') }}
        uses: peter-evans/create-pull-request@v3
        with:
          commit-message: 'style: run styler::style_pkg()'
          branch: style-code
          title: 'Style code'
          body: |
           Auto-generated by [style-r-code.yml][1]

            [1]: https://github.com/nmfs-stock-synthesis/workflows/tree/main/.github/workflows/style-r-code.yml

