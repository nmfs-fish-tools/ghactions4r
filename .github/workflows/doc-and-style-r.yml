# update documentation and style for R code
# This action runs both devtools::document() and styler::style_pkg() to style r code in an r pkg's repo. After
# styling, the changes are commited and a pull request to the branch the Workflow
# was started on is opened - this PR contains the commit.

# note may want to add a .gitignore file to .github/workflows in the repository that
# excludes *.rds files

# Workflow derived from https://github.com/r-lib/actions/tree/master/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
 workflow_call:
   inputs:
     run-rm_dollar_sign:
       required: false
       type: boolean
     pkg-is-r4ss:
       required: false
       type: boolean

name: style r code with styler

jobs:
  doc-and-style-r:
    name: doc and style
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v2

      - uses: r-lib/actions/setup-r@v1

      - uses: r-lib/actions/setup-r-dependencies@v1
        with:
          extra-packages: |
            styler
            roxygen2
            remotes

      - name: add r4ss, if using r4ss::rm_dollar_sign
        if: inputs.run-rm_dollar_sign == true && inputs.pkg-is-r4ss != true
        run: Rscript -e 'remotes::install_github("r4ss/r4ss", upgrade = "always")'

      - name: add r4ss, if using r4ss::rm_dollar_sign
        if: inputs.run-rm_dollar_sign == true && inputs.pkg-is-r4ss == true
        run: Rscript -e 'remotes::install_local(".", upgrade = "always")'

      - name: get last commit msg
        id: commit-msg
        run: |
          git tag
          last_commit_msg=$(git log -1 --pretty=%B)
          echo "::set-output name=msg::${last_commit_msg}"

      - name: Style
        id: style
        run: |
          Rscript -e 'styler::style_pkg()'
          changes=$(git status -s)
          echo "::set-output name=changes::${style-changes}"

      - name: commit updated style
        if: ${{ contains(steps.style.outputs.style-changes, 'M') }}
        run: |
          git config --local user.name "$GITHUB_ACTOR"
          git config --local user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git add \*.R
          git commit -m 'Style: run styler::style_pkg()'

      - name: Document
        id: doc
        run: |
          Rscript -e 'roxygen2::roxygenise()'
          changes=$(git status -s)
          echo "::set-output name=changes::${doc-changes}"

      - name: commit updated documents
        if: ${{ contains(steps.doc.outputs.doc-changes, 'M') }}
        run: |
          git config --local user.name "$GITHUB_ACTOR"
          git config --local user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git add man/\* NAMESPACE
          git commit -m 'docs: run devtools::document()'
      - name: Run run-rm_dollar_sign
        if: inputs.run-rm_dollar_sign == true
        run: |
          files_to_change <- list.files("R", full.names = TRUE)
          to_rm <- grep("rm_dollar_sign", files_to_change)
          if(isTRUE(length(to_rm)>0)) {
            files_to_change <- files_to_change[-to_rm]
          }
          out <- lapply(files_to_change, function(x) r4ss::rm_dollar_sign(x))
        shell: Rscript {0}

      - name: check if any changes
        id: dollar-sign
        if: inputs.run-rm_dollar_sign == true
        run: |
          dollar_changes=$(git status -s)
          echo "::set-output name=dollar_changes::${doll-sign-changes}"

      - name: commit rm_dollar_sign changes, if any
        if: inputs.run-rm_dollar_sign == true && ${{ contains(steps.dollar-sign.outputs.doll-sign-changes, 'M') }}
        run: |
          git config --local user.name "$GITHUB_ACTOR"
          git config --local user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git add man/\* NAMESPACE
          git commit -m 'run r4ss::rm_dollar_sign'

      - name: Style again, just in case
        run: Rscript -e 'styler::style_pkg()'

      - name: Document again, just in case
        run: |
          Rscript -e 'roxygen2::roxygenise()'

      - name: Create Pull Request
        if: ${{ !contains(steps.commit-msg.outputs.msg, 'run') }}
        uses: peter-evans/create-pull-request@v3
        with:
          commit-message: 'style and docs: run devtools::document() and styler::style_pkg()'
          branch: style-code
          title: 'Style code and document'
          body: |
           Auto-generated by [doc-and-style-r.yml][1]
            [1]: https://github.com/nmfs-stock-synthesis/workflows/tree/main/.github/workflows/doc-and-style-r.yml

