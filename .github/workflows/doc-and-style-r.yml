# update documentation and style for R code
# This action runs both devtools::document() and styler::style_pkg() to style r code in an r pkg's repo. After
# styling, the changes are commited and a pull request to the branch the Workflow
# was started on is opened - this PR contains the commit.

# Workflow derived from https://github.com/r-lib/actions/tree/master/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
 workflow_call:

name: style r code with styler

jobs:
  doc-and-style-r:
    name: style
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v2

      - uses: r-lib/actions/setup-r@v1

      - name: Install dependencies
        run: Rscript -e 'install.packages(c("styler", "roxygen2"))'

      - name: get last commit msg
        id: commit-msg
        run: |
          git tag
          last_commit_msg=$(git log -1 --pretty=%B)
          echo "::set-output name=msg::${last_commit_msg}"

      - name: Style
        id: style
        run: |
          Rscript -e 'styler::style_pkg()'
          changes=$(git status -s)
          echo "::set-output name=changes::${style-changes}"

      - name: commit updated style
        if: ${{ contains(steps.style.outputs.style-changes, 'M') }}
        run: |
          git config --local user.name "$GITHUB_ACTOR"
          git config --local user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git add \*.R
          git commit -m 'Style: run styler::style_pkg()'

      - name: Document
        id: doc
        run: |
          Rscript -e 'roxygen2::roxygenise()'
          changes=$(git status -s)
          echo "::set-output name=changes::${doc-changes}"

      - name: commit updated documents
        if: ${{ contains(steps.doc.outputs.doc-changes, 'M') }}
        run: |
          git config --local user.name "$GITHUB_ACTOR"
          git config --local user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git add man/\* NAMESPACE
          git commit -m 'docs: run devtools::document()'

      - name: Style again, just in case
        run: Rscript -e 'styler::style_pkg()'

      - name: Document again, just in case
        run: Rscript -e 'roxygen2::roxygenise()'

      - name: Create Pull Request
        if: ${{ !contains(steps.commit-msg.outputs.msg, 'run') }}
        uses: peter-evans/create-pull-request@v3
        with:
          commit-message: 'style and docs: run devtools::document() and styler::style_pkg()'
          branch: style-code
          title: 'Style code'
          body: |
           Auto-generated by [style-r-code.yml][1]

            [1]: https://github.com/nmfs-stock-synthesis/workflows/tree/main/.github/workflows/style-r-code.yml

